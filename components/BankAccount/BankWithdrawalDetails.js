import React from "react";
import {
    Modal,
    Form,
    Input,
    Select,
    Spin,
    message,
    Row,
    Col,
    DatePicker,
    Button,
} from "antd";
import { formItemLayout, tailFormItemLayout } from "$ACTIONS/constantsData";
import { get, post } from "$ACTIONS/TlcRequest";
import { ApiPort, APISETS } from "$ACTIONS/TLCAPI";
import moment from "moment";
import { formatAmount, dateFormat } from "$ACTIONS/util";
import { translate } from "$ACTIONS/Translate";

const { Item } = Form;

class BankWithdrawalDetails extends React.Component {
    constructor(props) {
        super(props);
        this.state = {
            isLoading: false,
            startDate: moment()
                .day(moment().day() - 13)
                .format(),
            endDate: moment().format(),
            minTime: new Date(new Date().getTime() - 31536000000).getTime(), //‰∏ÄÂπ¥
            maxTime: new Date().getTime(),
            username: "",
            BankName: "",
            Province: "",
            City: "",
            AccountNumber: "",
            Branch: "",
            LatestWithdrawalUpdateDate: "",
            TotalCountThreshold: 0,
            TotalAmountThreshold: 0,
            WithdrawalThresholdLimitCount: "",
            WithdrawalThresholdLimitAmount: "",
            startvalue: 0,
            endValue: 0,
            showStartDate: false,
            showEndDate: false,
            keyValue1: 1,
            keyValue2: 2,
        };
    }
    componentDidMount() {
        // get(ApiPort.GETMemberBanksfirst)
        //     .then((res) => {
        //         if (res && res.result && this.props.itemBankDetail) {
        //             const target = res.result.find((item) => {
        //                 return (
        //                     item.accountNumber ==
        //                     this.props.itemBankDetail.accountNumber
        //                 );
        //             });
        //             if (target) {
        //                 this.setState({
        //                     username: target.accountHolderName,
        //                     BankName: target.bankName,
        //                     Province: target.province,
        //                     City: target.city,
        //                     AccountNumber: target.accountNumber,
        //                     Branch: target.branch,
        //                 });
        //             }
        //         }
        //     })
        //     .catch((error) => {
        //         console.log(error);
        //     }).finally(()=>{
        //         this.props.setIsLoading(false);
        //     })

        // get(ApiPort.GetWithdrawalThresholdLimit)
        //     .then((res) => {
        //         if (res && res.result) {
        //             this.setState({
        //                 WithdrawalThresholdLimitCount:
        //                     res.result.withdrawalThresholdLimitCount,
        //                 WithdrawalThresholdLimitAmount:
        //                     res.result.withdrawalThresholdLimitAmount,
        //             });
        //         }
        //     })
        //     .catch((error) => {
        //         console.log(error);
        //     });
        // this.getWithdrawalThresholdHistory();
        this.renderBankDetail();
    }
    /**
     * Áî®props‰º†ÈÄíÁªôÊù•ÁöÑËØ¶ÊÉÖ,‰∏çÁî®ÂçïÁã¨ËØ∑Ê±Ç
     *
     * */
    renderBankDetail = () => {
        const { itemBankDetail } = this.props;
        console.log(
            "üöÄ ~ file: BankWithdrawalDetails.js:103 ~ BankWithdrawalDetails ~ item:",
            itemBankDetail,
        );
        if (itemBankDetail) {
            this.setState({
                username: itemBankDetail.accountHolderName,
                BankName: itemBankDetail.bankName,
                AccountNumber: itemBankDetail.accountNumber,
            });
        }
    };

    getWithdrawalThresholdHistory = () => {
        this.setState({ isLoading: true });
        get(
            ApiPort.GetWithdrawalThresholdHistory +
                "?startDate=" +
                moment(this.state.startDate).format("YYYY-MM-DD") +
                "T00:00:00" +
                "&endDate=" +
                moment(this.state.endDate).format("YYYY-MM-DD") +
                "T23:59:59" +
                APISETS,
        )
            .then((res) => {
                this.setState({ isLoading: false });
                if (res && res.result) {
                    let item = res.result.find(
                        (ele) =>
                            ele.bankAccountNum ==
                            this.props.itemBankDetail.accountNumber,
                    );
                    if (item) {
                        this.setState({
                            TotalCountThreshold: item.totalCountThreshold,
                            TotalAmountThreshold: item.totalAmountThreshold,
                            LatestWithdrawalUpdateDate:
                                item.latestWithdrawalUpdateDate,
                        });
                    } else {
                        this.setState({
                            TotalCountThreshold: 0,
                            TotalAmountThreshold: 0,
                            LatestWithdrawalUpdateDate: "ÊöÇÊó†Êõ¥Êñ∞",
                        });
                    }
                } else {
                    this.setState({
                        TotalCountThreshold: 0,
                        TotalAmountThreshold: 0,
                        LatestWithdrawalUpdateDate: "ÊöÇÊó†Êõ¥Êñ∞",
                    });
                }
            })
            .catch((error) => {
                console.log(error);
            });
    };
    disabledDate = (value) => {
        return (
            value &&
            (value.valueOf() < this.state.minTime ||
                value.valueOf() > this.state.maxTime)
        );
    };
    onStartChange = (v) => {
        this.setState({ showStartDate: true });
        let fourteenDays = 1209600000 - 8640000; //14Â§©
        let srartdate = moment(v.valueOf()).format();
        if (
            this.state.endValue == 0 ||
            (v.valueOf() <= this.state.endValue &&
                v.valueOf() >= this.state.endValue - fourteenDays)
        ) {
            this.setState(
                {
                    startDate: srartdate,
                    startvalue: v.valueOf(),
                },
                () => {
                    if (this.state.showEndDate) {
                        this.getWithdrawalThresholdHistory();
                    }
                },
            );
        } else {
            if (this.state.endValue > 0 && this.state.showEndDate) {
                this.setState({
                    startDate: srartdate,
                    startvalue: v.valueOf(),
                });
                message.error("Âè™ËÉΩÈÄâÊã©ÂçÅÂõõÂ§©‰ª•ÂÜÖÁöÑÊó•Êúü");
            }
        }
    };
    onEndChange = (v) => {
        this.setState({ showEndDate: true });
        let fourteenDays = 1209600000 - 8640000; //14Â§©
        let endDate = moment(v.valueOf()).format();
        if (
            this.state.startvalue == 0 ||
            (v.valueOf() <= this.state.startvalue + fourteenDays &&
                v.valueOf() >= this.state.startvalue)
        ) {
            this.setState(
                {
                    endDate: endDate,
                    endValue: v.valueOf(),
                },
                () => {
                    this.getWithdrawalThresholdHistory();
                },
            );
        } else {
            this.setState({ endDate: endDate, endValue: v.valueOf() });
            message.error("Âè™ËÉΩÈÄâÊã©ÂçÅÂõõÂ§©‰ª•ÂÜÖÁöÑÊó•Êúü");
        }
    };
    clearInputVlaue = (e) => {
        e.preventDefault();
        this.setState({
            showEndDate: false,
            showStartDate: false,
            keyValue1: new Date(),
            keyValue2: new Date(),
            endValue: 0,
        });
    };
    render() {
        const {
            username,
            BankName,
            Province,
            City,
            AccountNumber,
            Branch,
            LatestWithdrawalUpdateDate,
            WithdrawalThresholdLimitCount,
            WithdrawalThresholdLimitAmount,
            TotalCountThreshold,
            TotalAmountThreshold,
            minTime,
            maxTime,
            startDate,
            endDate,
        } = this.state;
        const { deleteCard, itemBankDetail } = this.props;
        return (
            <Modal
                title={translate("Èì∂Ë°åË¥¶Êà∑(Â§ßÂÜô)")}
                visible={this.props.visible}
                onCancel={() => this.props.closeModal(false)}
                closable={true}
                width={400}
                footer={[
                    <Button
                        size="large"
                        type="primary"
                        onClick={() => deleteCard(itemBankDetail.bankAccountID)}
                    >
                        {translate("Âà†Èô§")}
                    </Button>,
                ]}
                className="modal-pubilc bankDetailsModal"
                centered={true}
            >
                <Spin spinning={this.state.isLoading}>
                    <Form {...formItemLayout}>
                        <Row>
                            <Col span={24}>
                                <div>
                                    <span>{translate("Èì∂Ë°åÂêçÁß∞")}</span>
                                    <span>{BankName}</span>
                                </div>
                                <div>
                                    <span>{translate("Èì∂Ë°åË¥¶Âè∑")}</span>
                                    <span>
                                        {AccountNumber.replace(
                                            /\d(?=\d{3})/g,
                                            "*",
                                        )}
                                    </span>
                                </div>
                                <div>
                                    <span>{translate("Ë¥¶Êà∑ÊåÅÊúâËÄÖÂÖ®Âêç")}</span>
                                    <span>{username}</span>
                                </div>
                                {/* <div>
                                    <span>ÁúÅ/Ëá™Ê≤ªÂå∫</span>
                                    <span>{Province}</span>
                                </div>
                                <div>
                                    <span>ÂüéÂ∏Ç/ÂüéÈïá</span>
                                    <span>{City}</span>
                                </div>
                                <div>
                                    <span>ÂàÜË°å</span>
                                    <span>{Branch}</span>
                                </div> */}
                            </Col>
                            {/* <Col span={12}>
                                <p className="text1">ÊèêÊ¨æËÆ∞ÂΩï</p>
                                <p
                                    className="text2"
                                    style={{ color: "#b6b6b6" }}
                                >
                                    ÂèØÊü•ËØ¢‰∏ÄÂπ¥‰πãÂÜÖ 14 Êó•ÊúüÈó¥ÁöÑÊï∞ÊçÆËÆ∞ÂΩï
                                </p>
                                <p className="text3">
                                    ÊúÄËøëÊõ¥Êñ∞Ôºö{LatestWithdrawalUpdateDate}
                                </p>
                                <Item label="ÊêúÂØª" className="startDate-Item">
                                    {(this.state.showStartDate ||
                                        this.state.showEndDate) && (
                                        <span
                                            className="clearItem"
                                            onClick={this.clearInputVlaue}
                                        >
                                            Ê∏ÖÈô§
                                        </span>
                                    )}
                                    <DatePicker
                                        size="large"
                                        showToday={false}
                                        allowClear={false}
                                        dropdownClassName="disabled-date"
                                        style={{ width: "100%" }}
                                        defaultPickerValue={
                                            this.state.showStartDate
                                                ? moment(minTime)
                                                : null
                                        }
                                        disabledDate={this.disabledDate}
                                        format="YYYY-MM-DD"
                                        placeholder="ËØ∑ÈÄâÊã©ÂºÄÂßãÊó•Êúü"
                                        onChange={this.onStartChange}
                                        value={
                                            this.state.showStartDate
                                                ? moment(startDate)
                                                : null
                                        }
                                        key={this.state.keyValue1} //Âè™Áî®Êù•Ê∏ÖÈô§inputÁöÑÂÄº
                                    />
                                </Item>
                                <Item label="">
                                    <DatePicker
                                        size="large"
                                        showToday={false}
                                        allowClear={false}
                                        dropdownClassName="disabled-date"
                                        style={{ width: "100%" }}
                                        defaultPickerValue={
                                            this.state.showEndDate
                                                ? moment(maxTime)
                                                : null
                                        }
                                        disabledDate={this.disabledDate}
                                        format="YYYY-MM-DD"
                                        placeholder="ËØ∑ÈÄâÊã©ÁªìÊùüÊó•Êúü"
                                        onChange={this.onEndChange}
                                        value={
                                            this.state.showEndDate
                                                ? moment(endDate)
                                                : null
                                        }
                                        key={this.state.keyValue2} //Âè™Áî®Êù•Ê∏ÖÈô§inputÁöÑÂÄº
                                    />
                                </Item>
                                <p className="text4">
                                    <span>ÈÄöËøáÂÆ°Ê†∏ÁöÑÊèêÊ¨æÊÄªÊ¨°Êï∞</span>
                                    <span>{TotalCountThreshold}Ê¨°</span>
                                </p>
                                <p className="text5">
                                    <span>ÈÄöËøáÂÆ°Ê†∏ÁöÑÊèêÊ¨æÊÄªÈ¢ù</span>
                                    <span>
                                        ¬•{formatAmount(TotalAmountThreshold)}
                                    </span>
                                </p>
                                <p className="text6">
                                    ÂΩìÊÇ®‰ΩøÁî®Âêå‰∏ÄË¥¶Êà∑ÊèêÊ¨æ{" "}
                                    {WithdrawalThresholdLimitCount} Ê¨°ÊàñËææÂà∞ÊèêÊ¨æ{" "}
                                    {WithdrawalThresholdLimitAmount}{" "}
                                    ÊÄªÈ¢ùÊó∂Ôºå‰∏∫‰∫ÜÊÇ®Èì∂Ë°åË¥¶Êà∑ÂÆâÂÖ®Ëµ∑ËßÅÔºåÂª∫ËÆÆÊÇ®Êõ¥Êç¢ÊàñÊ∑ªÂä†Êñ∞ÁöÑÈì∂Ë°åË¥¶Êà∑ËøõË°åÊèêÊ¨æ„ÄÇ
                                </p>
                            </Col> */}
                        </Row>
                    </Form>
                </Spin>
            </Modal>
        );
    }
}

export default Form.create({ name: "AddBankCard" })(BankWithdrawalDetails);
